# 场景格式插件

场景格式插件为 MaiBot 提供沉浸式的场景对话体验。通过生成全局日程、场景描述和智能状态管理，让对话更具真实感和互动性。

## 功能特性

- ✅ **全局日程**：生成一个通用的今日日程，所有用户共享
- ✅ **场景模式**：提供 {地点}{着装}{场景} 格式的沉浸式对话
- ✅ **智能续接**：自动检测历史状态并生成过渡场景
- ✅ **双模型架构**：
  - Planner 模型：判断状态是否需要变化
  - Reply 模型：生成场景描述和回复内容
- ✅ **状态持久化**：使用 SQLite 保存日程和场景状态（每个用户独立状态）
- ✅ **灵活控制**：支持启动、关闭、重新初始化

## 安装

插件已集成到 MaiBot 插件系统，无需额外安装。

确保在 `config.toml` 中启用插件：

```toml
[plugin]
enabled = true
```

## 使用流程

### 1. 生成日程

首先使用 `/场景日程` 命令根据 bot 人设生成今日全局日程（所有用户共享）：

```
/场景日程
```

Bot 会返回：
```
✅ 今日日程生成成功！

【2025年01月15日 星期三】
  07:00-07:30  起床洗漱 @ 宿舍
  07:30-08:00  早餐 @ 食堂
  08:00-12:00  上课（数学、英语） @ 教室
  12:00-13:00  午餐 @ 食堂
  ...

已保存到数据库，可以使用 /scene on 开始场景对话
```

**注意**：日程是全局共享的，任何用户生成日程都会覆盖之前的日程。

### 2. 初始化场景（可选）

使用 `/scene init` 初始化场景信息（只初始化不启用）：

```
/scene init
```

返回：
```
✅ 场景已初始化（未启用）

📍 地点：教室
👗 着装：校服

🎬 场景：
我坐在教室第三排，窗外的阳光洒在课桌上...

使用 /scene on 启动场景模式
```

### 3. 启动场景模式

使用 `/scene on` 启动场景模式：

```
/scene on
```

**首次启动**：
```
✅ 场景模式已启用

{教室}
{校服}
{我坐在教室第三排，窗外的阳光洒在课桌上。老师正在黑板上写着数学公式，周围同学都在认真听讲。}

现在你可以开始场景对话了~
```

**续接模式**（有历史状态）：
```
✅ 场景模式已启用（续接上次对话）

【时间已过去 8.5 小时】
下午在图书馆看了会书，然后回宿舍吃了晚饭，洗了澡换了身舒服的衣服。

{宿舍}
{休闲便服}
{我坐在电脑前，屏幕上游戏角色正在副本里战斗。房间里开着暖黄的台灯，氛围很放松。}
```

### 3. 场景对话

在场景模式下，bot 的所有回复都会包含场景信息：

```
用户：今天的课还挺有意思的
Bot：{教室}
     {校服}
     {我转过头看着你，笑了笑。教室里很安静，只有笔尖划过纸张的沙沙声。}

     对呀！今天数学老师讲的那个题目挺有意思的，你听懂了吗？

---

用户：我们去图书馆吧
Bot：{走廊}
     {校服}
     {我站起身收拾好书包，和你一起走出教室。走廊里人不多，脚步声在安静的空间里回响。}

     好呀！正好下课了，去图书馆看会书也不错~

---

用户：到了
Bot：{图书馆}
     {校服}
     {我跟着你推开图书馆的门，书香气息扑面而来。找了个靠窗的位置坐下，周围很安静。}

     这里真安静，你想看什么书？我去找本数学习题集。
```

### 4. 关闭场景模式

```
/scene off
```

返回：
```
❌ 场景模式已关闭（状态已保留，下次 /scene on 可续接）
```

### 5. 重新初始化

如果想重新生成场景（但不启用）：

```
/scene init
```

返回：
```
✅ 场景已初始化（未启用）

{宿舍}
{便服}
{我坐在电脑前...}

使用 /scene on 启动场景模式
```

### 6. 查看状态

```
/scene
```

返回：
```
📍 当前场景状态：启用

地点：图书馆
着装：校服
场景：我坐在图书馆靠窗的位置，正在看书...

最后活动：看书
更新时间：2025-01-15 14:30:00
初始化时间：2025-01-15 12:00:00
```

## 配置说明

### config.toml

```toml
[plugin]
name = "scene_format_plugin"
enabled = true

[logging]
level = "INFO"
```

### Bot 人设配置

插件会自动读取 `bot_config.toml` 中的以下配置：
- `personality.personality`：Bot的性格特质和身份特征
- `personality.reply_style`：Bot的回复风格

这些配置将用于生成符合角色特点的日程和场景描述。

### 模型配置

插件使用双模型架构，需要在 `model_bot_config.toml` 中配置：

- **planner 模型**：用于判断状态是否需要变化（读取 `model_task_config.planner`）
- **reply 模型**：用于生成场景描述和回复（读取 `model_task_config.chat`）

## 数据库结构

插件使用 SQLite 存储数据，位于 `plugins/scene_format_plugin/data/scene.db`

### 表结构

#### schedules（日程表）
```sql
- user_id: 用户ID（全局日程使用 "global_schedule"）
- weekday: 星期几（0-6）
- time_start: 开始时间
- time_end: 结束时间
- activity: 活动名称
- description: 活动描述
- location: 地点
- clothing: 着装
```

**注意**：日程表使用固定的 `user_id = "global_schedule"` 存储全局日程，所有用户共享。

#### scene_states（场景状态表）
```sql
- chat_id: 会话ID（格式：{stream_id}:{user_id}）
- enabled: 是否启用
- location: 当前地点
- clothing: 当前着装
- scene_description: 场景描述
- last_activity: 最后活动
- last_update_time: 最后更新时间
- init_time: 初始化时间
- user_id: 用户ID
```

**注意**：每个用户的场景状态是独立的，不同用户可以有各自的场景。

#### scene_history（场景历史表）
```sql
- chat_id: 会话ID
- timestamp: 时间戳
- location: 地点
- clothing: 着装
- scene_description: 场景描述
- user_message: 用户消息
- bot_reply: bot回复
```

## 工作原理

### 1. 日程生成流程

```
用户：/场景日程
    ↓
读取 bot 人设（从 config.toml）
    ↓
调用 Reply 模型生成一周日程
    ↓
解析 JSON 并保存到 schedules 表
```

### 2. 场景初始化流程

```
用户：/scene on
    ↓
检查是否有历史状态？
    ├─ 无 → 初始化模式
    │       ↓
    │   查询当前日程
    │       ↓
    │   调用 Reply 模型生成初始场景
    │       ↓
    │   保存到 scene_states 表
    │
    └─ 有 → 续接模式
            ↓
        计算时间差
            ↓
        调用 Reply 模型生成过渡+新场景
            ↓
        更新 scene_states 表
```

### 3. 场景对话流程

```
用户发送消息
    ↓
POST_LLM 事件拦截
    ↓
检查场景模式是否启用？
    ├─ 否 → 放行到正常 LLM
    └─ 是 ↓
        步骤1：Planner 模型判断状态变化
              ↓
        步骤2：Reply 模型生成场景+回复
              ↓
        步骤3：更新数据库状态
              ↓
        步骤4：记录历史
              ↓
        步骤5：格式化输出
              ↓
        阻止原始 LLM 调用，返回场景回复
```

## 双模型架构

### Planner 模型职责

判断状态是否需要变化：

```json
{
  "地点变化": false,
  "地点变化原因": "用户只是在聊天，没有提到移动",
  "着装变化": false,
  "着装变化原因": "对话内容不涉及换装"
}
```

### Reply 模型职责

生成场景描述内容：

```json
{
  "地点": "图书馆",
  "着装": "校服",
  "场景": "我坐在图书馆靠窗的位置，周围很安静。阳光从窗外洒进来，照在书桌上，暖洋洋的。我翻开手中的数学习题集，准备开始复习。看着窗外偶尔路过的同学，心里想着：这里真安静，适合专心学习。"
}
```

## 注意事项

1. **全局日程共享**：所有用户共享同一个日程，任何人生成日程都会覆盖之前的
2. **场景状态独立**：每个用户的场景状态（地点、着装、场景描述）是独立的
3. **状态持久化**：关闭场景模式后状态会保留，下次启动会自动续接
4. **重新初始化**：使用 `/scene init` 重新初始化场景（不启用），需要 `/scene on` 才能启动
5. **模型配置**：确保 `model_bot_config.toml` 中配置了 planner 和 chat 模型

## 许可证

本插件为 MaiBot 的一部分，遵循 MaiBot 的许可证。

## 版本历史

- v1.0.0 (2025-01-15)
  - 首个版本发布
  - 实现日程生成、场景模式、智能续接
  - 双模型架构（Planner + Reply）
